# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
'on': pull_request
jobs:
  build_and_preview:
    if: '${{ github.event.pull_request.head.repo.full_name == github.repository }}'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: use Node.js ${{ matrix.node-version}}
        id: useNode
        uses: actions/setup-node@v4
        with:
          args: '. --sarif --output results.sarif || true'
          node-version: ${{ matrix.node-version}}
          cache: 'npm'
      - run: npm ci
      - run : npm install --global yarn    

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Docker and Docker Compose
        run: |
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker $USER
          newgrp docker
          docker version
          docker compose version || echo "Docker Compose v2 is now included in Docker CLI"

      - name: Run Docker Compose
        run: |
          docker compose up -d
          sleep 10 # Wait for services to fully start
          docker compose ps
          
      - name: Migrate prisma
        run : npx prisma migrate dev --name init
      - run: 'npm i '
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_SMARTCALENDAR_10297 }}'
          projectId: smartcalendar-10297
